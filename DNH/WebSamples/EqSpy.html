<!---
Sample: 
	Equipment Spy
Description:
	A proof of concept for a property grid interface that creates
	a simple procedurally generated UI based of reflection info. 
	
	The UI will dynamically change as equipment is added, removed,
	and as property values change.
--->

<html>
	<head>
		<title>Equipment Spy</title>
	</head>
	<body>
		<!--- CONNECTION CONTROLS --->
		<hr>
			<input id="dnhdns" value="localhost"/><br/>
			<input id="dnhport" value="5001"/><br/>
			<button id="con" onclick="BtnConnect()">Connect</button>
			<button id="dcon" onclick="BtnDisconnect()" style="display:none">Disconnect</button>
		<hr>
			<div id="ctrctnr"/><!--- All UI will be placed in the control container --->
	</body>
	
	<script>
	
// WebSocket connection
var socket = null;

// An object that maps Equipment GUIDs to their
// Param data and references to their UI widgets.
var uirefs = {};

/**
* Toggles the visbility of the Connect and Disconnect button.
*
* It ensures only one is visible at a time.
* @param  {Bool} iscon  If the connection button should be shown, True.
*/
function SetConBtns(iscon)
{
	let btncon = document.getElementById("con");
	let btndcon = document.getElementById("dcon");
	if(iscon)
	{
		btncon.style.display = "none";
		btndcon.style.display = "inline";
	}
	else
	{
		btncon.style.display = "inline";
		btndcon.style.display = "none";
	}
}

/**
* Connects the client to the specified DNH, based on the login
* UI values.
*/
function BtnConnect()
{
	let btncon = document.getElementById("con");
	
	let indns = document.getElementById("dnhdns");
	let inport = document.getElementById("dnhport");
	socket = new WebSocket('ws://'+indns.value+':'+inport.value+'/realtime');
	
	// WebSocket callback when the connection is 
	// successfully opened with the server.
	socket.addEventListener(
		"open", 
		function(evt)
		{
			SetConBtns(true);
			
			reg = {};
			reg["apity"] = "register";
			reg["type"] = "spectator";
			reg["name"] = "EquipmentGUI_Sample";
			socket.send(JSON.stringify(reg));
		});
		
	// WebSocket callback for when a message is 
	// received from the server.
	socket.addEventListener(
		"message", 
		function (evt) 
		{
			req = JSON.parse(evt.data);
			apity = req.apity;
			console.log(evt.data);
			
			if(apity == "register")
			{
				reg = {};
				reg["apity"] = "equipment";
				socket.send(JSON.stringify(reg));
			}
			else if(apity == "equipment")
			{
				
				let eqs = req["equipment"];
				
				// Create UI for each equipment.
				for(let eit = 0; eit < eqs.length; eit++)
				{
					eq = eqs[eit];
					CreateEquipmentUI(eq);
				}
			}
			else if(apity == "valset" || apity == "changedval")
			{
				// If we get a response from changing a value, or a notification
				// that a value has changed, change the value in our UI widget
				// to be up to date.
				let ids = req["ids"];
				for(let i = 0; i < ids.length; i++)
				{
					let id = ids[i];
					presp = req["sets"][id];
					if(presp["status"] != "success")
						continue;
						
					let guid = req["guid"];
					let p = uirefs[guid]["params"][id];
					
					p["current"] = presp["val"]
					UpdateWidget(guid, id);
				}
			}
			else if(apity == "changedroster")
			{
				if(req["change"] == "rem")
				{
					// Remove the UI for the Equipment that was removed.
					let guid = req["guid"];
					let guidUI = document.getElementById(guid);
					guidUI.remove();
					delete uirefs[guid];
				}
				else
				{
					// Query Equipments so we can process the new addition.
					reg = {};
					reg["apity"] = "equipment";
					socket.send(JSON.stringify(reg));
				}
			}
			
			
		});
		
	// WebSocket callback when an error has been detected.
	socket.addEventListener("error", function (evt) {Shutdown();});
	
	// WebSocket callback for when the connection is 
	// intentionally closed
	socket.addEventListener("close", function (evt) {Shutdown();});
}

/**
* Add a new UI section for an Equipment.
* @param  {Object} eq  	The registration JSON of the Equipment.	
*/
function CreateEquipmentUI(eq)
{
	let guid = eq["guid"];
	if( guid in uirefs)
		return;

	let ctrls = document.getElementById("ctrctnr");				
	
	newEq = {};
	newEq["type"] = eq["type"];
	newEq["name"] = eq["name"];
	newEq["manufacturer"] = eq["manufacturer"];
	newEq["params"] = {};
	
	// Create UI for the Equipment
	eqdiv = document.createElement('div');
	eqdiv.id = guid;
	eqname = document.createElement('h1');
	eqname.innerText = newEq["name"];
	eqdiv.append(eqname);
	ctrls.append(eqdiv);
	
	// Create UI for each parameter
	for(let i = 0; i < eq["params"].length; i++)
	{
		param = eq["params"][i];
		let id = param["id"];
		newEq[id] = eq;
		
		let nametxt = document.createTextNode(param["label"]);
		eqdiv.append(nametxt);
		
		// Create the appropriate UI widget for the Param, based
		// on what datatype the Param is.
		let pty = param["type"];
		let newwidget = null;
		if(pty == "bool")
		{
			newwidget = document.createElement('input');
			newwidget.type = "checkbox";
			newwidget.checked = param["current"];
			newwidget.onchange = ()=>{OnBoolChange(guid, id, newwidget);};
			
		}
		else if(pty == "float")
		{
			newwidget = document.createElement('input');
			newwidget.type = "text"
			newwidget.value = String(param["current"]);
			newwidget.onchange = ()=>{OnFloatChange(guid, id, newwidget);};
		}
		else if(pty == "int")
		{
			newwidget = document.createElement('input');
			newwidget.type = "text"
			newwidget.value = String(param["current"]);
			newwidget.onchange = ()=>{OnIntChange(guid, id, newwidget);};
		}
		else if(pty == "string")
		{
			newwidget = document.createElement('input');
			newwidget.type = "text"
			newwidget.value = param["current"];
			newwidget.onchange = ()=>{OnStringChange(guid, id, newwidget);};
		}
		else if(pty == "enum")
		{
			newwidget = document.createElement('select');
			newwidget.type = "select";
			
			for(let sid = 0; sid < param["possible"].length; sid++)
			{
				let opt = param["possible"][sid];
				let optele = document.createElement('option');
				optele.value = opt;
				optele.innerText = opt;
				newwidget.append(optele);
			}
			
			newwidget.value = param["current"];
			newwidget.onchange = ()=>{OnEnumChange(guid, id, newwidget);};
		}
		param["widget"] = newwidget;
		eqdiv.append(newwidget);
		newEq["params"][id] = param;
		
		eqdiv.append(document.createElement('br'));
	}
	uirefs[guid] = newEq;
}

/**
* UI Callback for when a bool UI widget has its value changed by the user.
* @param  {String} 	guid	The GUID of the Equipment that owns the bool Param.
* @param  {String} 	id   	The ID of the bool Param.
* @param  {Input} 	cb 		The checkbox input UI to extract the changed value from.
*/
function OnBoolChange(guid, id, cb)
{
	req = {};
	req["apity"] = "valset";
	req["guid"] = guid;
	req["sets"] = {}
	req["sets"][id] = cb.checked;
	
	// Request to server to change the value
	socket.send(JSON.stringify(req));
}

/**
* UI Callback for when a float UI widget has its value changed by the user.
* @param  {String} 	guid  	The GUID of the Equipment that owns the float Param.
* @param  {String} 	id   	The ID of the float Param.
* @param  {Input} 	input 	The text input UI to extract the changed value from.
*/
function OnFloatChange(guid, id, input)
{
	let v = parseFloat(input.value);
	if(v == NaN)
	{
		input.value = uirefs[guid]["params"][id]["current"];
		UpdateWidget(guid, id);
		return;
	}
	
	req = {}
	req["apity"] = "valset";
	req["guid"] = guid;
	req["sets"] = {}
	req["sets"][id] = v;
	
	// Request to server to change the value
	socket.send(JSON.stringify(req));
}

/**
* UI Callback for when a bool UI widget has its value changed by the user.
* @param  {String} 	guid  	The GUID of the Equipment that owns the int Param.
* @param  {String} 	id   	The ID of the int Param.
* @param  {Input} 	input 	The text input UI to extract the changed value from.
*/
function OnIntChange(guid, id, input)
{
	let v = parseInt(input.value);
	if(v == NaN)
	{
		input.value = uirefs[guid]["params"][id]["current"];
		UpdateWidget(guid, id);
		return;
	}
	
	req = {}
	req["apity"] = "valset";
	req["guid"] = guid;
	req["sets"] = {}
	req["sets"][id] = v;
	
	// Request to server to change the value
	socket.send(JSON.stringify(req));
}

/**
* UI Callback for when a string UI widget has its value changed by the user.
* @param  {String} guid  	The GUID of the Equipment that owns the string Param.
* @param  {String} id   	The ID of the string Param.
* @param  {Input} input 	The text input UI to extract the changed value from.
*/
function OnStringChange(guid, id, input)
{
	req = {}
	req["apity"] = "valset";
	req["guid"] = guid;
	req["sets"] = {}
	req["sets"][id] = input.value;
	
	// Request to server to change the value
	socket.send(JSON.stringify(req));
}

/**
* UI Callback for when an enum UI widget has its value changed by the user.
* @param  {String} guid  	GUID of the Equipment that owns the enum Param.
* @param  {String} id   	The ID of the enum Param.
* @param  {Select} select 	The select UI to extract the changed value from.
*/
function OnEnumChange(guid, id, select)
{
	req = {}
	req["apity"] = "valset";
	req["guid"] = guid;
	req["sets"] = {}
	req["sets"][id] = select.value;
	
	// Request to server to change the value
	socket.send(JSON.stringify(req));
}

/**
* Update the value presented for a UI widget
* representing an Equipment's Param.
* @param  {String} guid  	The GUID of the Equipment that owns the Param.
* @param  {String} id   	The ID of the Param.
*/
function UpdateWidget(guid, id)
{
	let p = uirefs[guid]["params"][id];
	
	let widg = p["widget"];
	if(widg.type == 'checkbox')
		widg.checked = presp["val"];
	else if(widg.type == 'text')
		widg.value = String(presp["val"]);
	else if(widg.type == 'select-one')
		widg.value = String(presp["val"]);
}

/**
* Disconnect from the DNH server when the "Disconnect" button is pressed.
*/
function BtnDisconnect()
{
	if(socket)
		socket.close();
}

/**
* Disconnect from the server.
*/
function Shutdown()
{
	let ctrls = document.getElementById("ctrctnr");
	
	// Clear the UI region
	ctrls.innerHTML = "";
	
	// Clear any JavaScript knowledge of the 
	// equipments and UI.
	uirefs = {}
	
	SetConBtns(false);
}
	</script>
</html>