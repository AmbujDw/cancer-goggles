<!---
Sample: 
	Bus Spy
Description:
	A utility that registers itself to the DNH so that it can report
	what is being broadcasted on the bus.
--->

<html>
	<head>
		<title>CVG Hub Spy</title>
	</head>
	<body>
A simple example of connecting to the DNH, as well as viewing update messages

<!--- CONNECTION CONTROLS --->
		<hr>
		<input id="dnhdns" value="localhost"/><br/>
		<input id="dnhport" value="5701"/><br/>
		<button id="con" onclick="BtnConnect()">Connect</button>
		<button id="dcon" onclick="BtnDisconnect()" style="display:none">Disconnect</button>

<!--- OUTPUT LOG --->
		<hr>
		<button id="clear" onclick="BtnClear()">Clear</button><br/>
		<div id="output"></div>

	</body>

<!--- LOGIC ---> 
<!--- 
While Not the best practice to be in the html element 
(traditionally it should be in the <head>)it keeps the 
sections of the example simpler. 
--->
<script>

// WebSocket connection
var socket = null;

/**
* Send a message to the server, and also output that payload to the screen.
* @param  {String} msg  	The message payload to send and display.
*/
function SendAndShow(msg)
{
	if(!socket)
		return;
	
	Log("SENDING: " + msg);
	socket.send(msg);
}

/**
* Connects the client to the specified DNH, based on the login
* UI values.
*/
function BtnConnect()
{
	let btncon = document.getElementById("con");
	
	let indns = document.getElementById("dnhdns");
	let inport = document.getElementById("dnhport");
	socket = new WebSocket('ws://'+indns.value+':'+inport.value+'/realtime');
	
	// WebSocket callback when the connection is 
	// successfully opened with the server.
	socket.addEventListener(
		"open", 
		function(evt)
		{
			var btncon = document.getElementById("con");
			var btndcon = document.getElementById("dcon");
			btncon.style.display = "none"
			btndcon.style.display = "inline"
			
			Log("CONNECTED!");
			Log("Registering Equipment...");
			
			reg = {};
			reg["apity"] = "register";
			reg["type"] = "spectator";
			reg["name"] = "BusSpy";
			SendAndShow(JSON.stringify(reg));
		});
		
	// WebSocket callback for when a message is 
	// received from the server.
	socket.addEventListener(
		"message", 
		function (evt) 
		{
			Log('Message from server<br\>' + event.data);
		});
		
	// WebSocket callback when an error has been detected.
	socket.addEventListener(
		"error", 
		function (evt) 
		{
			Log("CONNECTION CLOSED from error");
			var btncon = document.getElementById("con");
			var btndcon = document.getElementById("dcon");
			btncon.style.display = "none"
			btndcon.style.display = "inline"
		});
		
	// WebSocket callback for when the connection is 
	// intentionally closed
	socket.addEventListener(
		"close", 
		function (evt) 
		{
			Log("CONNECTION CLOSED");
			var btncon = document.getElementById("con");
			var btndcon = document.getElementById("dcon");
			btncon.style.display = "none"
			btndcon.style.display = "inline"
		});
}

/**
* Disconnect from the DNH server when the "Disconnect" button is pressed.
*/
function BtnDisconnect()
{
	if(socket)
		socket.close();
}

/**
* Clear the log when the "Clear" button is pressed.
*/
function BtnClear()
{
	var divoutp = document.getElementById("output");
	divoutp.innerHTML = "";
}

/**
* Append text to the log.
* @param  {String} msg  	The message to append to the log.
*/
function Log(msg)
{
	var divoutp = document.getElementById("output");
	divoutp.innerHTML += msg + "<br/><br/>";
}
</script>
</html>